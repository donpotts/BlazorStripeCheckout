@using System.Security.Claims
@inject AppService AppService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject BlazorStripeCheckout.Shared.Blazor.Services.CartService CartService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inherits LayoutComponentBase
@implements IDisposable


<MudThemeProvider @ref="@mudThemeProvider" @bind-IsDarkMode="@_dark" />
<MudAppBar>
<AuthorizeView>
    @if (!CheckedVariable)
    {
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
    }
</AuthorizeView>
    <MudText Class="d-flex mr-8">Blazor Stripe Checkout</MudText>
    <MudHidden Breakpoint="Breakpoint.SmAndUp" Invert="true">
        <MudTooltip Text="@tooltipText">    
            <MudSwitch T="bool" Class="d-flex justify-content-start " Value="CheckedVariable" ValueChanged="@(e => OnSwitchValueChanged((bool)e))" Color="Color.Success" UncheckedColor="Color.Secondary" />
        </MudTooltip>
    </MudHidden>
    <MudSpacer />
    <MudHidden Breakpoint="Breakpoint.SmAndUp" Invert="true" IsHiddenChanged="ScreenSizeChanged">
    @if (CheckedVariable)
    {
        <MudToolBar>
            <MudLink Href="/" Class="d-flex px-4" Color="Color.Inherit">Home</MudLink>
            <AuthorizeView>
                <MudLink Href="/cardproducts" Class="d-flex px-4" Color="Color.Inherit">Products</MudLink>
            </AuthorizeView>
            <AuthorizeView Roles="Administrator">
                <MudLink Href="/products" Class="d-flex px-4" Color="Color.Inherit">Products Admin</MudLink>
                <MudLink Href="/user" Class="d-flex px-4" Color="Color.Inherit">User</MudLink>
            </AuthorizeView>
            <AuthorizeView>
                <Authorized>
                    <MudLink Href="/account/changePassword" Class="d-flex px-4" Color="Color.Inherit">Change Password</MudLink>
                    <MudLink Href="/logout" Class="d-flex px-4" Color="Color.Inherit">Logout (@context.User.Identity!.Name)</MudLink>
                </Authorized>
                <NotAuthorized>
                    <MudLink Href="/register" Class="d-flex px-4" Color="Color.Inherit">Register</MudLink>
                    <MudLink Href="/login" Class="d-flex px-4" Color="Color.Inherit">Login</MudLink>
                </NotAuthorized>
            </AuthorizeView>
        </MudToolBar>
    }
    </MudHidden>
    <AuthorizeView>
        <Authorized>
            @if (IsOnCardProductsPage() && CartService.CartCount > 0)
            {
                <MudBadge Origin="Origin.CenterCenter" Content="@CartService.CartCount" Color="Color.Error" Overlap="true" >
                    <MudIconButton Icon="@Icons.Material.Filled.ShoppingCart" Color="Color.Inherit" Edge="Edge.Start" Style="margin-right:15px;" OnClick="@(() => ToggleCartDrawer(true))" />
                </MudBadge>
            }
            else if (IsOnCardProductsPage())
            {
                <MudIconButton Icon="@Icons.Material.Filled.ShoppingCart" Color="Color.Inherit" Edge="Edge.Start" Style="margin-right:10px;" OnClick="@(() => ToggleCartDrawer(true))" />
            }
        </Authorized>
    </AuthorizeView>
    <MudIconButton Icon="@Icons.Material.Filled.WbSunny" Color="@(_dark ? Color.Warning : Color.Inherit)" Edge="Edge.Start" OnClick="@(() => _dark = !_dark)" />
    <MudLink Href="https://www.radendpoint.com/" Color="Color.Inherit">About</MudLink>
</MudAppBar>
@if (!CheckedVariable)
{
<AuthorizeView Context="authContext">
<Authorized>
    <MudDrawer @bind-Open="drawerOpen" ClipMode="DrawerClipMode.Docked">
        <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">Home</MudNavLink>
        <AuthorizeView>
            <MudNavLink Href="/cardproducts" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.TableChart">Products</MudNavLink>
        </AuthorizeView>
        <AuthorizeView Roles="Administrator">
            <MudNavLink Href="/products" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.TableChart">Products Admin</MudNavLink>
            <MudNavLink Href="/user" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.People">User</MudNavLink>
        </AuthorizeView>
        <AuthorizeView>
            <Authorized>
                <MudNavLink Href="/account/changePassword" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Edit">Change Password</MudNavLink>
                <MudNavLink Href="/logout" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Logout">Logout (@authContext.User.Identity!.Name)</MudNavLink>
            </Authorized>
            <NotAuthorized>
                <MudNavLink Href="/register" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Edit">Register</MudNavLink>
                <MudNavLink Href="/login" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Login">Login</MudNavLink>
            </NotAuthorized>
        </AuthorizeView>
    </MudDrawer>
</Authorized>
</AuthorizeView>
}
<MudDrawer @bind-Open="ShoppingCartDrawerOpen" Anchor="Anchor.Right" Variant="DrawerVariant.Temporary" Width="500px">
        <div style="padding: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <MudText Typo="Typo.h6" Color="Color.Primary">Shopping Cart</MudText>
                <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Inherit" OnClick="@(() => ToggleCartDrawer(false))" />
            </div>
            
            @if (CartService.CartItems?.Any() == true)
            {
                <div style="max-height: calc(100vh - 300px); overflow-y: auto;">
                    @foreach (var item in CartService.CartItems)
                    {
                        <MudCard style="margin-bottom: 8px;">
                            <MudCardContent>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <MudText Typo="Typo.body1">@item.Name</MudText>
                                        <MudText Typo="Typo.body1">@item.Description</MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">$@item.Price?.ToString("F2")</MudText>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <MudIconButton Icon="@Icons.Material.Filled.Remove" Size="Size.Small" OnClick="@(() => UpdateQuantity(item, -1))" />
                                        <MudText>@item.Quantity</MudText>
                                        <MudIconButton Icon="@Icons.Material.Filled.Add" Size="Size.Small" OnClick="@(() => UpdateQuantity(item, 1))" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => RemoveItem(item))" />
                                    </div>
                                </div>
                            </MudCardContent>
                        </MudCard>
                    }
                </div>
                
                <MudDivider style="margin: 16px 0;" />
                
                <div style="padding: 16px 0;">
                    <MudText Typo="Typo.h6" style="margin-bottom: 8px;">Order Summary</MudText>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <MudText>Subtotal:</MudText>
                        <MudText>$@subtotal.ToString("F2")</MudText>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <MudText>Tax (8.75%):</MudText>
                        <MudText>$@tax.ToString("F2")</MudText>
                    </div>
                    
                   
                    <MudDivider style="margin: 12px 0;" />
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                        <MudText Typo="Typo.h6">Total:</MudText>
                        <MudText Typo="Typo.h6" Color="Color.Primary">$@total.ToString("F2")</MudText>
                    </div>
                    
                    <MudButton FullWidth="true" Variant="Variant.Filled" Color="Color.Primary" style="margin-bottom: 8px;" OnClick="@HandleCheckout">
                        Checkout
                    </MudButton>
                    <MudButton FullWidth="true" Variant="Variant.Outlined" OnClick="@(() => ToggleCartDrawer(false))">
                        Continue Shopping
                    </MudButton>
                </div>
            }
            else
            {
                <div style="text-align: center; padding: 32px 0;">
                    <MudIcon Icon="@Icons.Material.Filled.ShoppingCartCheckout" Style="font-size: 64px; color: #666; margin-bottom: 16px;" />
                    <MudText Typo="Typo.h6" style="margin-bottom: 8px;">Your cart is empty</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" style="margin-bottom: 16px;">Add some products to get started!</MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => ToggleCartDrawer(false))">
                        Browse Products
                    </MudButton>
                </div>
            }
        </div>
    </MudDrawer>
    <NavMenuCartContent OnCheckout="HandleCheckout" />
@code {
    private bool drawerOpen = true;
    bool _dark = true;
    private bool isDarkMode;
    private MudThemeProvider? mudThemeProvider;
    private bool isSwitchChecked = true;
    private bool CheckedVariable;
    private string tooltipText => isSwitchChecked ? "Top Menu ON" : "Top Menu is OFF";
    private bool isOnCardProductsPage;

    // Tip logic
    private int tipPercent = 18;
    private decimal customTip = 0;
    private decimal subtotal => CartService.CartItems?.Sum(x => x.Price.GetValueOrDefault() * x.Quantity) ?? 0;
    private decimal tax => Math.Round(subtotal * 0.0875m, 2);
    private decimal tip => customTip > 0 ? customTip : Math.Round(subtotal * tipPercent / 100m, 2);
    private decimal total => subtotal + tax; // + tip;


    // Controls the shopping cart drawer visibility
    private bool ShoppingCartDrawerOpen { get; set; } = false;

    private void ToggleCartDrawer(bool open)
    {
        ShoppingCartDrawerOpen = open;
        StateHasChanged();
    }

    protected override void OnInitialized()
    {
        NavigationManager.LocationChanged += HandleLocationChanged;
        isOnCardProductsPage = CheckIsOnCardProductsPage();
        CartService.CartChanged += OnCartChanged;
    }

    private void OnCartChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void HandleLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        isOnCardProductsPage = CheckIsOnCardProductsPage();
        StateHasChanged();
    }

    private bool CheckIsOnCardProductsPage()
    {
        return NavigationManager.Uri.EndsWith("/cardproducts", StringComparison.OrdinalIgnoreCase);
    }

    private bool IsOnCardProductsPage() => isOnCardProductsPage;

    private void DrawerToggle()
    {
        drawerOpen = !drawerOpen;
    }

    public void ScreenSizeChanged(bool hidden)
    {
        if (hidden)
            CheckedVariable = false;
        else
            CheckedVariable = isSwitchChecked;
    }

    public void OnSwitchValueChanged(bool checkedValue)
    {
        CheckedVariable = checkedValue;
        if (checkedValue)
            isSwitchChecked = true;
        else
            isSwitchChecked = false;
    }
          
     // Define the IsBusy variable
    private bool IsBusy { get; set; } = false;

    // Fix the RemoveFromCart call to pass the Id property
    private async Task RemoveItem(BlazorStripeCheckout.Shared.Blazor.Services.CartProduct item)
    {
        if (item.Id.HasValue)
        {
            await CartService.RemoveFromCartAsync(item.Id.Value);
            //Snackbar.Add($"{item.Name} removed from cart.", Severity.Normal);
        }
    }

    // Remove the call to UpdateCartItem as it does not exist
    private async Task UpdateQuantity(BlazorStripeCheckout.Shared.Blazor.Services.CartProduct item, int delta)
    {
        if (item.Id.HasValue)
        {
            await CartService.UpdateQuantityAsync(item.Id.Value, delta);
        }
    }

    private async Task HandleCheckout()
    {
        try
        {
            IsBusy = true; // Set busy state

            // Log the CartService.CartItems
            Console.WriteLine("CartService.CartItems: " + 
                (CartService.CartItems != null 
                    ? string.Join(", ", CartService.CartItems.Select(x => $"{x.Name} (Qty: {x.Quantity})")) 
                    : "Cart is empty"));

            // Ensure CartService.CartItems is converted to a List<CartProduct>
            var cartProducts = CartService.CartItems?.Select(x => new CartProduct
            {
                Id = x.Id,
                Name = x.Name,
                Description = x.Description ?? "No description provided", // Ensure Description is populated
                Price = x.Price >= 1 ? x.Price : 1, // Ensure Price is at least 1
                Quantity = x.Quantity >= 1 ? x.Quantity : 1 // Ensure CartQuantity is at least 1
            }).ToList();

            // Log the cartProducts
            Console.WriteLine("cartProducts: " + 
                (cartProducts != null 
                    ? string.Join(", ", cartProducts.Select(x => $"{x.Name} (Qty: {x.Quantity}, Price: {x.Price})")) 
                    : "Cart is empty"));

            if (cartProducts == null || !cartProducts.Any())
            {
                Snackbar.Add("Cart is empty.", Severity.Error);
                return;
            }

            // Call the AppService method with the prepared cartProducts
            var result = await AppService.CreateCheckoutSessionAsync(cartProducts);

            if (!string.IsNullOrEmpty(result.ErrorMessage))
            {
                Snackbar.Add(result.ErrorMessage, Severity.Error);
                return;
            }

            if (!string.IsNullOrEmpty(result.Url))
            {
                NavigationManager.NavigateTo(result.Url, true); // Redirect to Stripe Checkout
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error during checkout: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsBusy = false; // Reset busy state
        }
    }

    public void Dispose()
    {
        // Unsubscribe from events to avoid memory leaks
        NavigationManager.LocationChanged -= HandleLocationChanged;
        if (CartService != null)
        {
            CartService.CartChanged -= OnCartChanged;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && mudThemeProvider != null)
        {
            isDarkMode = await mudThemeProvider.GetSystemPreference();
            StateHasChanged();

            await mudThemeProvider.WatchSystemPreference(OnSystemPreferenceChanged);
        }
    }

    protected Task OnSystemPreferenceChanged(bool isDarkMode)
    {
        this.isDarkMode = isDarkMode;
        StateHasChanged();

        return Task.CompletedTask;
    }
}
